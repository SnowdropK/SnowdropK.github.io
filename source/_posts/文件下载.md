---
title: 文件下载
date: 2021-09-05 21:12:17
tags:
---

## 一、字节
### 概念
`字节（Byte）`是计算机信息技术用于计量存储容量的一种计量单位，也表示一些计算机编程语言中的数据类型和语言字符。

一个字节存储8位无符号数，储存的数值范围为0-255。

### Byte与bit
`数据存储`是以`“字节”（Byte）`为单位，`数据传输`大多是以`“位”（bit，又名“比特”）为单位`，一个位就代表一个0或1（即二进制），每8个位（bit，简写为b）组成一个字节（Byte，简写为B），是最小一级的信息单位。

有控制码或非美标码的文件，通常不能在不同电脑系统间直接交换。这类文件有一个通称，叫“二进制文件”(`Binary Files`)。
```js
1字节(Byte)=8位(bit)
1KB( Kilobyte，千字节)=1024B
1MB( Megabyte，兆字节)=1024KB
1GB( Gigabyte，吉字节，千兆)=1024MB
1TB( Trillionbyte，万亿字节，太字节)=1024GB
1PB( Petabyte，千万亿字节，拍字节)=1024TB
1EB( Exabyte，百亿亿字节，艾字节)=1024PB
1ZB(Zettabyte，十万亿亿字节，泽字节)=1024EB
1YB( Yottabyte，一亿亿亿字节，尧字节)=1024ZB
1BB( Brontobyte，千亿亿亿字节)=1024YB
```
## 二、编码

### 概念
在计算机中，所有的数据在存储和运算时都要使用二进制数表示（因为计算机用高电平和低电平分别表示1和0），例如，像a、b、c、d等52个字母（包括大写）以及0、1等数字还有一些常用的符号（例如*、#、@等）在计算机中存储时也要使用二进制数来表示。

而具体用哪些二进制数字表示哪个符号，当然每个人都可以约定自己的一套（这就叫`编码`），而如果要想互相通信而不造成混乱，那么就必须使用相同的编码规则。美国有关的标准化组织就出台了`ASCII编码`，统一规定了上述常用符号用哪些二进制数来表示。

### 编码标准
文字编码标准主要有`ASCII`、`GB2312`、`GBK`、`Unicode`等。

`ASCII`：编码是美国信息交换标准编码（美标）。

`GB2312`、`GBK`、`GB18030`：汉字字符编码方案的国家标准。

`BIG5码`：针对繁体汉字的汉字编码，在台湾、香港的电脑系统中普遍应用。

`Unicode`：宽字节字符集，它对每个字符都固定使用两个字节即16位表示（普及到东亚国家发展出的编码标准）（UCS4、UTF-8、UTF-16都是Unicode的编码方案。其中UTF-8因可以兼容`ASCII`而被广泛使用。）。
***
`Base64编码`：现有的字符集非常多，常用的有 `UTF-8 / GBK` 等, 这里面的某些字节在某些传输渠道。比如邮件传输就不支持上面`ASCII`码中的控制字符， `Base64`的创建就是为了解决此问题。

Base64内的64是指64个字符, 分别是 `A-Z, a-z, 0-9, +, /`，Base64 相应的索引表如下:

![777.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77bef7962ce2444ab587ae323fef5893~tplv-k3u1fbpfcp-watermark.image)

### ASCII码与Base64的编解码
`Base64`有64个字符， 2^6 = 64，所以每个`Base64编码`字符可以用一个
`6位的二进制`来表示。这样的话如果有`3个字节的二进制`, 可以用`4位Base64字符`表示。

编码流程如下:
1. `ASCII码`字符串根据ASCII码对照表转换为`二进制数值`；
1. 把`二进制数值`按每`6位`进行划分；
1. 然后`6位二进制`转化为`十进制`根据对照表找到`Base64编码字符`；

![777.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77bc38238947453abd341dc80441767b~tplv-k3u1fbpfcp-watermark.image)

由图可知，`Man`（3 字节）编码的结果为 `TWFu`（4 字节），很明显经过 base64 编码后体积会增加 1/3。`Man` 这个字符串的长度刚好是 3，可以用 4 个 base64 单元来表示。

>如果待编码字符串的长度不是3的倍数，为了可以整除6编译出完整的字节数, 就需要使用 0 字节值在末尾补足，使其能够被 3 整除，然后再进行 base64 的编码。

>如果有连续`6位都是0的话, 就用“=”来表示`。

![777.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e33f301ebd440f5bd2b34d7ccbb3946~tplv-k3u1fbpfcp-watermark.image)

![777.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c3720cfb7aaf438b8b713817fc1b3a4f~tplv-k3u1fbpfcp-watermark.image)

### base64编码与解码
+ btoa()：该函数能够基于二进制数据 “字符串” 创建一个 base64 编码的 ASCII 字符串。
+ atob()： 该函数能够`解码`通过 base64 编码的字符串数据。

## 三、下载相关函数
### Object URL
Object URL 是一种伪协议，也被称为 Blob URL。它允许 Blob 或 File 对象用作图像，下载二进制数据链接等的 URL 源。在浏览器中，我们使用 `URL.createObjectURL` 方法来创建 Blob URL，该方法接收一个 `Blob` 对象，并为其创建一个唯一的 URL，其形式为 `blob:<origin>/<uuid>`，对应的示例如下：
```
blob:https://example.org/40a5fb5a-d56d-4a33-b4e2-0acf6a8e5f641
```
虽然存储了 URL → Blob 的映射，但 Blob 本身仍驻留在内存中，浏览器无法释放它。映射在文档卸载时自动清除，因此 Blob 对象随后被释放。但是，如果应用程序寿命很长，那不会很快发生。因此，如果我们创建一个 Blob URL，即使不再需要该 Blob，它也会存在内存中。

针对这个问题，可以调用 `URL.revokeObjectURL(url)` 方法，从内部映射中删除引用，从而允许删除 Blob（如果没有其他引用），并释放内存。

### Blob
#### 概念
`Blob（Binary Large Object）`表示二进制类型的大对象。在数据库管理系统中，将二进制数据存储为一个单一个体的集合。Blob 通常是影像、声音或多媒体文件。**「在 JavaScript 中 Blob 类型的对象表示不可变的类似文件对象的原始数据。」**

Blob 对象含有两个属性：size 和 type。其中 `size` 属性用于表示数据的大小（以字节为单位），`type` 是 `MIME 类型`的字符串。

![777.jpg](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e555c210a68d4125ae42bd8af69c5850~tplv-k3u1fbpfcp-watermark.image)

![777.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/00eaba29e2954032879ccffc37cc0711~tplv-k3u1fbpfcp-watermark.image)

#### 构造函数
```
var aBlob = new Blob(blobParts, options);
```
-   blobParts：它是一个由 ArrayBuffer，ArrayBufferView，Blob，DOMString 等对象构成的数组。DOMStrings 会被编码为 UTF-8。

-   options：一个可选的对象，包含以下两个属性：

    -   type —— 默认值为 `""`，它代表了将会被放入到 blob 中的数组内容的 MIME 类型。
    -   endings —— 默认值为 `"transparent"`，用于指定包含行结束符 `\n` 的字符串如何被写入。 它是以下两个值中的一个： `"native"`，代表行结束符会被更改为适合宿主操作系统文件系统的换行符，或者 `"transparent"`，代表会保持 blob 中保存的结束符不变。

```js
let myBlobParts = ['<html><h2>Hello Semlinker</h2></html>']; // an array consisting of a single DOMString
let myBlob = new Blob(myBlobParts, {type : 'text/html', endings: "transparent"}); // the blob

console.log(myBlob.size + " bytes size");
// Output: 37 bytes size
console.log(myBlob.type + " is the type");
// Output: text/html is the type
```

### ArrayBuffer
ArrayBuffer 对象用来表示**「通用的、固定长度的」**原始二进制数据缓冲区。** **「ArrayBuffer 不能直接操作，而是要通过类型数组对象 或 `DataView`对象来操作」**，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容。

### Unit8Array
Uint8Array 数组类型表示一个 8 位无符号整型数组，创建时内容被初始化为 0。创建完后，可以以**「对象的方式或使用数组下标索引的方式」** 引用数组中的元素。
```js
new Uint8Array(); // ES2017 最新语法
new Uint8Array(length); // 创建初始化为0的，包含length个元素的无符号整型数组
new Uint8Array(typedArray);
new Uint8Array(object);
new Uint8Array(buffer [, byteOffset [, length]]);
```

## 四、文件下载

### 4.1 a标签下载
```js
function dataUrlToBlob(base64, mimeType) {
  let bytes = window.atob(base64.split(",")[1]);
  let ab = new ArrayBuffer(bytes.length);
  let ia = new Uint8Array(ab);
  for (let i = 0; i < bytes.length; i++) {
    ia[i] = bytes.charCodeAt(i);
  }
  return new Blob([ab], { type: mimeType });
}

// 保存文件
function saveFile(blob, filename) {
  const a = document.createElement("a");
  a.download = filename;
  a.href = URL.createObjectURL(blob);
  a.click();
  URL.revokeObjectURL(a.href)
}
```

### 4.2 showSaveFilePicker API 下载
[showSaveFilePicker](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2Fwindow%2FshowSaveFilePicker "https://developer.mozilla.org/en-US/docs/Web/API/window/showSaveFilePicker") 方法支持一个对象类型的可选参数，可包含以下属性：

-   `excludeAcceptAllOption`：布尔类型，默认值为 `false`。默认情况下，选择器应包含一个不应用任何文件类型过滤器的选项（由下面的 `types` 选项启用）。将此选项设置为 `true` 意味着 `types` 选项不可用。

-   `types`：数组类型，表示允许保存的文件类型列表。数组中的每一项是包含以下属性的配置对象：

    -   `description（可选）`：用于描述允许保存文件类型类别。
    -   `accept`：是一个对象，该对象的 `key` 是 [MIME](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FBasics_of_HTTP%2FMIME_types%2FCommon_types "https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types") 类型，值是文件扩展名列表。
    
```js
async function saveFile(blob, filename) {
  try {
    const handle = await window.showSaveFilePicker({
      suggestedName: filename,
      types: [
        {
          description: "PNG file",
          accept: {
            "image/png": [".png"],
          },
        },
        {
          description: "Jpeg file",
          accept: {
            "image/jpeg": [".jpeg"],
          },
         },
      ],
     });
    const writable = await handle.createWritable();
    await writable.write(blob);
    await writable.close();
    return handle;
  } catch (err) {
     console.error(err.name, err.message);
  }
}

function download() {
  if (!imgDataUrl) {
    alert("请先合成图片");
    return;
  }
  const imgBlob = dataUrlToBlob(imgDataUrl, "image/png");
  saveFile(imgBlob, "face.png");
}
```

### 4.3 FileSaver 下载
[FileSaver.js](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Feligrey%2FFileSaver.js "https://github.com/eligrey/FileSaver.js") 是在客户端保存文件的解决方案，非常适合在客户端上生成文件的 Web 应用程序。它是 HTML5 版本的 saveAs() FileSaver 实现，支持大多数主流的浏览器，其兼容性如下图所示：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/740514537fac41219196d26cecce17f5~tplv-k3u1fbpfcp-zoom-1.image)
```js
FileSaver saveAs(
 Blob/File/Url, 
 optional DOMString filename, 
 optional Object { autoBom }
)
```

### 4.4 base64 格式下载
**Base64** 是一种基于 64 个可打印字符来表示二进制数据的表示方法。由于 2⁶ = 64 ，所以每 6 个比特为一个单元，对应某个可打印字符。3 个字节有 24 个比特，对应于 4 个 base64 单元，即 3 个字节可由 4 个可打印字符来表示。相应的转换过程如下图所示：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c89ee6d5625e435cba0984c7841b6dce~tplv-k3u1fbpfcp-zoom-1.image)

**Base64 常用在处理文本数据的场合，表示、传输、存储一些二进制数据，包括 MIME 的电子邮件及 XML 的一些复杂数据。** 在 [MIME](https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FBasics_of_HTTP%2FMIME_types "https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types") 格式的电子邮件中，base64 可以用来将二进制的字节序列数据编码成 ASCII 字符序列构成的文本。使用时，在传输编码方式中指定 base64。使用的字符包括大小写拉丁字母各 26 个、数字 10 个、加号 + 和斜杠 /，共 64 个字符，等号 = 用来作为后缀用途。

